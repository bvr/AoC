
use 5.16.3;
use Test::More;
use Path::Class qw(file);
use List::AllUtils qw(natatime);
use Data::Dump qw(dd pp);
use experimental 'smartmatch';
no strict "vars";

sub inst(&) {
    my ($f) = @_;
    my $pkg = caller;

    return sub {
        my ($a, $b, $c, $regs) = @_;
        no strict 'refs';
        local *{"${pkg}::a"} = \$a;
        local *{"${pkg}::b"} = \$b;
        local *{"${pkg}::r"} = $regs;
        my $result_regs = eval pp $regs;
        $result_regs->[$c] = $f->();
        return $result_regs;
    };
}

my %inst = (
    addr => inst { $r[$a] + $r[$b] },
    addi => inst { $r[$a] + $b },
    mulr => inst { $r[$a] * $r[$b] },
    muli => inst { $r[$a] * $b },
    banr => inst { $r[$a] & $r[$b] },
    bani => inst { $r[$a] & $b },
    borr => inst { $r[$a] | $r[$b] },
    bori => inst { $r[$a] | $b },
    setr => inst { $r[$a] },
    seti => inst { $a },
    gtir => inst { $a > $r[$b]      ? 1 : 0 },
    gtri => inst { $r[$a] > $b      ? 1 : 0 },
    gtrr => inst { $r[$a] > $r[$b]  ? 1 : 0 },
    eqir => inst { $a == $r[$b]     ? 1 : 0 },
    eqri => inst { $r[$a] == $b     ? 1 : 0 },
    eqrr => inst { $r[$a] == $r[$b] ? 1 : 0 },
);

my @opcodes = qw(
    eqir
    borr
    addr
    gtri
    muli
    gtir
    mulr
    banr
    bori
    eqri
    eqrr
    bani
    setr
    gtrr
    addi
    seti
);


dd sample_match_opcodes([3, 2, 1, 1], [9, 2, 1, 2], [3, 2, 2, 1]);

my $input_file = "../input/16.txt";
my @input = file($input_file)->slurp(chomp => 1);
my $three = natatime 4, @input;
my $count = 0;
%histogram = ();
while(my @items = $three->()) {
    last if $items[0] eq '';
    my $before = [ $items[0] =~ /\d+/g ];
    my $op     = [ $items[1] =~ /\d+/g ];
    my $after  = [ $items[2] =~ /\d+/g ];
    my @matches = sample_match_opcodes($before, $op, $after);

    $histogram{ scalar @matches }{ join ', ', @matches }{ $op->[0] }++;
    $count++ if @matches >= 3;

    # record instruction
    if(@matches == 1) {
        $opcodes[$op->[0]] = $matches[0];
    }
}
is $count, 614, 'part 1';

# dd \%histogram;
# dd \@opcodes;

my $registers = [0,0,0,0];
while(<DATA>) {
    my @line = /\d+/g;
    $registers = $inst{ $opcodes[ $line[0] ] }->(@line[1..3], $registers);
}
dd $registers;


done_testing;


sub sample_match_opcodes {
    my ($before, $inst, $after) = @_;

    my %ops = ();
    while(my ($code, $op) = each %inst) {
        my $regs = $op->($inst->[1], $inst->[2], $inst->[3], $before);
        $ops{ $code }++ if $regs ~~ $after;
    }

    return keys %ops;
}


# dd $inst{addr}->(0,1 => 2, [10, 12, 14, 16]);

__DATA__
15 1 2 1
4 0 0 0
14 0 3 0
15 0 0 2
11 0 2 1
4 1 1 1
4 1 3 1
2 3 1 3
15 3 0 1
15 2 2 0
3 0 1 1
4 1 2 1
2 3 1 3
15 0 2 1
15 3 0 2
1 0 2 0
4 0 3 0
2 0 3 3
12 3 3 2
4 3 0 0
14 0 2 0
15 2 1 1
4 2 0 3
14 3 2 3
10 0 3 3
4 3 2 3
2 2 3 2
12 2 2 3
15 3 3 1
15 0 3 0
15 3 0 2
11 1 2 1
4 1 2 1
4 1 3 1
2 3 1 3
12 3 3 1
15 1 0 3
15 2 2 0
15 1 3 2
13 0 3 3
4 3 3 3
2 3 1 1
12 1 0 2
15 3 3 1
4 0 0 0
14 0 1 0
15 2 1 3
6 0 3 3
4 3 3 3
4 3 3 3
2 2 3 2
12 2 3 1
15 2 1 3
15 0 2 2
4 2 0 0
14 0 2 0
10 0 3 0
4 0 3 0
4 0 2 0
2 1 0 1
12 1 3 3
15 3 2 2
4 0 0 0
14 0 2 0
15 1 2 1
1 0 2 0
4 0 1 0
2 3 0 3
12 3 1 1
15 2 2 3
4 1 0 0
14 0 2 0
15 2 2 2
10 0 3 0
4 0 3 0
2 0 1 1
4 1 0 2
14 2 3 2
15 0 2 3
15 2 2 0
0 3 2 0
4 0 2 0
2 1 0 1
12 1 3 0
15 2 0 2
15 3 3 3
15 3 3 1
3 2 1 1
4 1 2 1
4 1 1 1
2 1 0 0
4 2 0 1
14 1 0 1
4 1 0 3
14 3 0 3
5 3 2 3
4 3 1 3
2 0 3 0
15 2 2 3
15 1 0 1
8 2 3 3
4 3 1 3
2 3 0 0
12 0 0 1
15 3 2 2
4 2 0 0
14 0 3 0
4 0 0 3
14 3 3 3
11 3 2 2
4 2 2 2
2 1 2 1
12 1 0 0
15 2 3 3
15 2 1 1
15 2 3 2
8 1 3 1
4 1 2 1
2 0 1 0
12 0 2 2
15 2 3 0
4 2 0 3
14 3 1 3
15 3 2 1
3 0 1 0
4 0 1 0
2 2 0 2
12 2 2 3
15 0 0 2
15 1 1 0
2 0 0 2
4 2 3 2
2 2 3 3
15 0 1 0
15 3 2 2
11 1 2 2
4 2 3 2
2 3 2 3
15 2 0 2
4 1 0 1
14 1 0 1
15 1 3 0
12 0 2 2
4 2 1 2
2 2 3 3
12 3 1 2
15 2 3 1
15 2 1 3
4 2 0 0
14 0 2 0
10 0 3 1
4 1 1 1
4 1 2 1
2 1 2 2
15 3 0 1
15 1 0 3
7 1 0 3
4 3 1 3
2 2 3 2
12 2 3 3
15 1 1 1
15 3 0 0
15 3 0 2
15 2 0 2
4 2 2 2
2 2 3 3
12 3 0 2
15 0 1 1
4 0 0 0
14 0 2 0
4 3 0 3
14 3 0 3
8 0 3 0
4 0 3 0
2 0 2 2
4 1 0 0
14 0 1 0
15 3 3 1
15 2 3 3
14 0 1 0
4 0 1 0
4 0 1 0
2 2 0 2
12 2 3 0
4 0 0 1
14 1 2 1
4 3 0 2
14 2 2 2
15 0 1 3
8 1 3 1
4 1 1 1
4 1 2 1
2 1 0 0
4 0 0 1
14 1 1 1
15 3 3 2
0 3 2 3
4 3 1 3
2 0 3 0
12 0 2 1
15 0 3 2
15 1 0 0
15 2 0 3
0 2 3 2
4 2 1 2
2 1 2 1
12 1 2 2
15 3 0 1
14 0 1 3
4 3 3 3
2 2 3 2
12 2 1 1
15 0 3 3
4 0 0 0
14 0 2 0
15 0 1 2
8 0 3 0
4 0 2 0
2 0 1 1
12 1 2 3
15 3 0 0
15 3 1 1
4 0 0 2
14 2 2 2
3 2 0 0
4 0 3 0
2 3 0 3
4 3 0 1
14 1 2 1
4 2 0 0
14 0 3 0
15 0 3 2
11 0 2 2
4 2 2 2
4 2 3 2
2 2 3 3
12 3 0 2
15 3 1 1
15 1 1 3
15 2 3 0
13 0 3 0
4 0 1 0
4 0 1 0
2 2 0 2
12 2 3 3
4 0 0 0
14 0 1 0
15 2 3 2
4 3 0 1
14 1 0 1
12 0 2 0
4 0 1 0
4 0 1 0
2 0 3 3
12 3 3 1
15 0 0 3
15 3 0 0
5 3 2 0
4 0 3 0
2 1 0 1
15 2 1 0
15 3 1 2
9 0 2 3
4 3 3 3
2 1 3 1
12 1 1 2
15 3 0 1
15 2 2 3
8 0 3 3
4 3 1 3
2 2 3 2
12 2 1 1
15 2 3 2
15 1 0 3
4 1 0 0
14 0 1 0
12 0 2 2
4 2 3 2
2 1 2 1
15 2 2 2
15 0 2 3
15 2 3 0
5 3 2 3
4 3 2 3
2 1 3 1
12 1 3 2
15 3 2 1
15 2 2 3
8 0 3 0
4 0 1 0
4 0 3 0
2 0 2 2
12 2 2 0
15 1 1 3
15 0 2 1
15 2 1 2
2 3 3 1
4 1 2 1
2 0 1 0
12 0 3 2
4 1 0 0
14 0 2 0
4 1 0 3
14 3 2 3
15 2 3 1
10 0 3 0
4 0 3 0
2 0 2 2
12 2 1 3
15 2 1 0
15 3 2 2
15 1 3 1
6 1 0 1
4 1 1 1
4 1 2 1
2 3 1 3
12 3 0 1
15 2 0 3
9 0 2 2
4 2 3 2
4 2 3 2
2 2 1 1
15 0 2 3
15 3 2 2
15 1 2 0
0 3 2 3
4 3 2 3
2 3 1 1
12 1 2 3
15 0 2 1
14 0 1 2
4 2 1 2
2 2 3 3
12 3 1 0
15 2 0 3
15 2 2 2
15 2 2 1
8 1 3 2
4 2 3 2
4 2 3 2
2 0 2 0
15 1 3 3
15 2 1 2
2 3 3 1
4 1 3 1
2 1 0 0
12 0 3 2
15 2 2 3
4 0 0 0
14 0 2 0
4 0 0 1
14 1 0 1
10 0 3 1
4 1 2 1
2 1 2 2
15 3 0 0
15 2 1 1
7 0 3 0
4 0 3 0
2 2 0 2
12 2 1 3
4 2 0 2
14 2 3 2
15 1 0 0
4 0 2 2
4 2 2 2
2 2 3 3
12 3 3 2
15 3 1 1
15 2 0 0
15 2 1 3
10 0 3 3
4 3 3 3
2 3 2 2
12 2 2 3
15 0 3 0
15 1 0 2
11 1 2 0
4 0 2 0
2 3 0 3
12 3 1 2
4 0 0 3
14 3 0 3
15 2 0 0
15 0 3 1
8 0 3 1
4 1 3 1
2 1 2 2
12 2 0 0
15 1 1 2
15 1 3 3
15 3 0 1
2 3 3 1
4 1 2 1
2 0 1 0
12 0 1 2
15 1 1 0
15 2 0 3
15 2 3 1
6 0 3 3
4 3 3 3
2 3 2 2
15 3 1 3
2 0 0 3
4 3 2 3
2 2 3 2
12 2 0 1
15 3 1 2
15 2 0 0
15 1 0 3
9 0 2 3
4 3 1 3
4 3 1 3
2 3 1 1
4 0 0 3
14 3 3 3
15 3 0 0
15 2 1 2
3 2 0 3
4 3 2 3
2 3 1 1
15 3 1 2
4 0 0 3
14 3 3 3
15 1 3 0
11 3 2 2
4 2 2 2
2 2 1 1
15 3 1 2
15 2 1 0
9 0 2 2
4 2 3 2
2 2 1 1
12 1 2 3
15 0 0 2
4 1 0 1
14 1 3 1
15 1 3 0
4 0 2 1
4 1 1 1
2 3 1 3
12 3 0 2
15 3 1 0
15 3 1 3
15 2 0 1
7 0 1 0
4 0 1 0
2 2 0 2
12 2 1 0
15 0 2 1
15 0 0 3
15 3 3 2
0 3 2 2
4 2 2 2
4 2 1 2
2 2 0 0
12 0 0 1
15 3 3 3
15 2 2 2
15 1 1 0
12 0 2 0
4 0 2 0
2 1 0 1
15 3 2 2
15 0 2 3
15 0 1 0
0 3 2 0
4 0 1 0
2 0 1 1
12 1 2 2
15 2 1 3
4 2 0 1
14 1 1 1
15 1 2 0
6 1 3 3
4 3 1 3
2 3 2 2
12 2 2 3
15 0 0 2
4 2 0 0
14 0 3 0
15 0 0 1
15 2 0 0
4 0 3 0
2 0 3 3
12 3 1 2
4 0 0 1
14 1 2 1
15 3 3 0
15 1 0 3
2 3 3 1
4 1 1 1
2 2 1 2
12 2 2 0
15 1 2 2
15 0 2 1
2 3 3 2
4 2 1 2
4 2 2 2
2 2 0 0
12 0 1 3
4 3 0 1
14 1 2 1
15 2 2 2
15 3 1 0
7 0 1 0
4 0 2 0
4 0 2 0
2 0 3 3
12 3 2 1
4 3 0 2
14 2 0 2
15 1 3 0
4 3 0 3
14 3 2 3
6 0 3 3
4 3 1 3
2 1 3 1
12 1 3 2
15 1 2 1
15 2 3 3
6 0 3 1
4 1 2 1
4 1 2 1
2 1 2 2
12 2 1 0
15 0 1 3
4 1 0 2
14 2 2 2
15 3 3 1
3 2 1 3
4 3 3 3
4 3 1 3
2 3 0 0
4 0 0 2
14 2 1 2
15 3 1 3
15 0 3 1
11 3 2 2
4 2 1 2
2 0 2 0
15 2 3 3
15 0 2 2
4 2 0 1
14 1 1 1
0 2 3 2
4 2 1 2
4 2 3 2
2 0 2 0
12 0 2 2
15 3 0 3
15 2 1 0
7 3 0 3
4 3 3 3
4 3 1 3
2 2 3 2
12 2 2 0
15 1 0 3
4 0 0 1
14 1 2 1
4 2 0 2
14 2 3 2
1 1 2 3
4 3 3 3
4 3 2 3
2 3 0 0
12 0 3 3
15 1 3 0
4 3 0 2
14 2 2 2
12 0 2 0
4 0 1 0
4 0 2 0
2 3 0 3
12 3 1 1
15 1 3 3
15 3 0 2
15 2 3 0
1 0 2 0
4 0 1 0
2 1 0 1
15 2 2 0
13 0 3 3
4 3 1 3
4 3 1 3
2 1 3 1
12 1 1 2
15 2 1 3
15 1 3 1
10 0 3 1
4 1 2 1
4 1 3 1
2 2 1 2
15 0 0 3
15 3 0 1
3 0 1 1
4 1 1 1
4 1 1 1
2 2 1 2
12 2 3 1
15 2 3 3
15 2 1 2
8 2 3 3
4 3 2 3
2 3 1 1
12 1 0 2
15 0 2 1
4 1 0 3
14 3 1 3
6 3 0 1
4 1 1 1
4 1 2 1
2 1 2 2
12 2 0 3
15 3 1 0
15 3 0 2
15 2 1 1
1 1 0 2
4 2 3 2
4 2 2 2
2 2 3 3
12 3 1 0
15 3 2 1
15 2 0 3
4 3 0 2
14 2 0 2
0 2 3 3
4 3 3 3
2 3 0 0
15 1 1 2
4 3 0 3
14 3 3 3
15 2 0 1
7 3 1 3
4 3 3 3
4 3 1 3
2 3 0 0
12 0 3 3
4 0 0 1
14 1 0 1
15 0 3 0
15 3 1 2
15 2 0 2
4 2 3 2
2 3 2 3
12 3 2 1
15 0 2 2
15 1 2 3
15 2 2 0
4 3 2 2
4 2 1 2
4 2 1 2
2 1 2 1
12 1 2 2
15 2 0 1
13 0 3 3
4 3 3 3
2 2 3 2
4 1 0 1
14 1 0 1
15 2 2 3
4 2 0 0
14 0 0 0
15 3 0 1
4 1 3 1
2 2 1 2
12 2 0 3
15 2 3 0
15 2 3 1
15 3 1 2
1 1 2 2
4 2 2 2
2 3 2 3
12 3 3 1
15 2 1 2
15 3 0 3
15 1 3 0
12 0 2 3
4 3 3 3
2 3 1 1
15 0 2 3
12 0 2 0
4 0 2 0
2 1 0 1
12 1 0 3
15 0 2 1
15 3 0 0
3 2 0 1
4 1 3 1
4 1 3 1
2 3 1 3
15 0 2 2
15 3 3 1
9 2 0 1
4 1 3 1
2 3 1 3
12 3 2 2
15 0 0 1
4 3 0 3
14 3 2 3
7 0 3 1
4 1 1 1
2 1 2 2
15 2 1 1
15 2 3 0
15 1 0 3
2 3 3 0
4 0 3 0
2 0 2 2
12 2 2 1
15 3 2 2
15 0 1 3
15 3 2 0
15 2 3 3
4 3 2 3
4 3 2 3
2 1 3 1
12 1 1 0
4 1 0 3
14 3 1 3
15 1 3 1
4 1 2 2
4 2 2 2
4 2 1 2
2 2 0 0
12 0 3 2
15 3 0 3
15 2 1 1
15 0 1 0
7 3 1 3
4 3 1 3
4 3 2 3
2 2 3 2
12 2 0 0
15 3 2 2
15 3 3 1
4 3 0 3
14 3 0 3
0 3 2 3
4 3 3 3
2 0 3 0
4 1 0 1
14 1 1 1
4 2 0 2
14 2 1 2
15 2 2 3
6 1 3 3
4 3 3 3
2 0 3 0
12 0 2 1
15 0 3 2
15 2 0 0
15 2 0 3
0 2 3 0
4 0 1 0
2 0 1 1
12 1 1 0
15 1 1 1
0 2 3 1
4 1 2 1
2 1 0 0
4 2 0 1
14 1 2 1
15 2 3 2
15 0 3 3
5 3 2 1
4 1 3 1
2 1 0 0
15 1 1 2
15 0 2 1
15 1 1 3
14 3 1 2
4 2 3 2
2 2 0 0
12 0 0 2
15 3 3 0
15 3 1 1
4 1 1 1
2 2 1 2
12 2 0 3
15 3 0 2
15 3 0 1
11 1 2 0
4 0 2 0
4 0 1 0
2 3 0 3
12 3 3 0
15 2 0 3
15 1 1 1
4 1 0 2
14 2 2 2
6 1 3 1
4 1 3 1
2 0 1 0
12 0 3 1
4 3 0 0
14 0 3 0
15 3 2 3
15 0 0 2
9 2 0 2
4 2 1 2
4 2 3 2
2 2 1 1
12 1 0 2
15 1 1 3
4 3 0 0
14 0 2 0
15 2 3 1
13 0 3 1
4 1 2 1
2 2 1 2
12 2 2 3
15 3 3 1
4 3 0 2
14 2 3 2
15 1 2 0
15 2 0 1
4 1 3 1
4 1 2 1
2 1 3 3
15 2 1 2
15 3 2 1
15 2 0 0
3 2 1 0
4 0 3 0
4 0 1 0
2 3 0 3
12 3 0 2
4 0 0 3
14 3 2 3
15 3 3 0
15 1 2 1
7 0 3 1
4 1 1 1
4 1 1 1
2 2 1 2
12 2 1 3
15 0 3 1
4 3 0 2
14 2 2 2
4 0 0 0
14 0 1 0
12 0 2 1
4 1 2 1
4 1 2 1
2 3 1 3
12 3 1 1
15 0 0 2
15 1 1 3
15 3 1 0
11 0 2 0
4 0 3 0
2 1 0 1
12 1 1 0
4 0 0 3
14 3 2 3
4 2 0 2
14 2 2 2
15 3 1 1
3 2 1 3
4 3 1 3
4 3 2 3
2 0 3 0
12 0 3 1
15 3 1 0
15 3 3 3
15 3 0 2
11 0 2 3
4 3 3 3
2 3 1 1
12 1 1 3
4 0 0 1
14 1 3 1
15 2 3 0
1 0 2 2
4 2 3 2
4 2 1 2
2 2 3 3
12 3 3 1
15 3 0 2
15 1 1 3
1 0 2 3
4 3 2 3
2 1 3 1
4 2 0 0
14 0 1 0
15 2 2 3
15 0 2 2
2 0 0 0
4 0 3 0
4 0 3 0
2 0 1 1
12 1 2 3
15 3 0 0
4 2 0 2
14 2 2 2
15 2 3 1
1 1 0 2
4 2 3 2
2 2 3 3
12 3 2 2
4 0 0 0
14 0 0 0
4 2 0 1
14 1 1 1
15 2 2 3
6 1 3 0
4 0 2 0
4 0 1 0
2 0 2 2
12 2 2 0
15 3 0 3
15 1 3 2
15 2 3 2
4 2 3 2
4 2 1 2
2 0 2 0
15 0 2 3
15 0 0 1
15 3 1 2
15 1 2 1
4 1 2 1
4 1 2 1
2 1 0 0
15 0 0 1
15 0 3 2
4 2 0 3
14 3 2 3
0 2 3 3
4 3 3 3
2 0 3 0
12 0 1 3
15 1 3 1
4 3 0 0
14 0 1 0
2 0 0 0
4 0 3 0
2 0 3 3
12 3 3 2
15 3 0 3
4 0 0 0
14 0 2 0
4 3 0 1
14 1 3 1
3 0 1 3
4 3 3 3
2 3 2 2
12 2 1 0
15 0 1 3
15 2 3 2
3 2 1 1
4 1 2 1
2 1 0 0
12 0 2 2
15 2 1 0
15 0 1 1
15 2 3 3
10 0 3 3
4 3 1 3
2 3 2 2
12 2 3 1
15 3 1 3
15 1 1 2
15 0 0 0
15 2 0 0
4 0 2 0
4 0 2 0
2 0 1 1
15 0 0 3
15 3 0 0
11 0 2 2
4 2 3 2
2 1 2 1
12 1 1 2
4 3 0 3
14 3 2 3
15 2 2 0
4 3 0 1
14 1 3 1
15 3 0 3
4 3 1 3
2 2 3 2
12 2 2 1
15 0 0 2
15 2 1 3
10 0 3 2
4 2 2 2
4 2 1 2
2 1 2 1
12 1 0 2
15 1 3 1
10 0 3 0
4 0 1 0
2 0 2 2
12 2 1 3
15 0 2 0
15 0 2 2
15 2 0 1
4 1 3 1
2 3 1 3
15 3 3 0
15 2 2 2
4 0 0 1
14 1 2 1
7 0 1 1
4 1 3 1
2 1 3 3
4 0 0 1
14 1 2 1
4 0 0 0
14 0 1 0
12 0 2 2
4 2 1 2
2 2 3 3
12 3 3 1
4 1 0 3
14 3 0 3
15 2 0 2
12 0 2 3
4 3 2 3
4 3 2 3
2 3 1 1
12 1 0 0
